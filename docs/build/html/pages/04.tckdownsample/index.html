<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>downsample tractograms &mdash; micapipe  documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinx_tabs/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/mica-pipe_colors.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.js"></script>
        <script src="../../_static/sphinx_tabs/tabs.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="FAQ" href="../04.faq/index.html" />
    <link rel="prev" title="Building gradients" href="../04.gradients/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #261F4A" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/html_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../01.install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01.whatyouneed/index.html">Usages Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01.whatsnew/index.html">What’s new?</a></li>
</ul>
<p class="caption"><span class="caption-text">Processing modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02.structuralproc/index.html">Structural processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02.dwiproc/index.html">Diffusion-weighted imaging processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02.restingstateproc/index.html">fMRI processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02.microstructproc/index.html">Microstructural profile covariance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02.qc/index.html">Quality control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02.aslproc/index.html">Arterial spin labeling processing</a></li>
</ul>
<p class="caption"><span class="caption-text">Additional tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../05.mic2bids/index.html">From DICOMS to BIDS: <code class="docutils literal notranslate"><span class="pre">mic2bids</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../05.micapipe_cleanup/index.html"><code class="docutils literal notranslate"><span class="pre">micapipe_cleanup</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../05.micapipe_anonymize/index.html"><code class="docutils literal notranslate"><span class="pre">micapipe_anonymize</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../05.autotract/index.html">Automatic Bundle Segmentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../04.start2end/index.html">Processing step by step: start to finish with <code class="docutils literal notranslate"><span class="pre">micapipe</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../04.databases/index.html">Processing databases with <code class="docutils literal notranslate"><span class="pre">micapipe</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../04.matrices/index.html">Main output matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04.surfaces/index.html">Surface visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04.gradients/index.html">Building gradients</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">How to downsample a tractogram</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#changes-before-and-after-downsampling-a-tractogram">Changes before and after downsampling a tractogram</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#number-of-points">Number of points</a></li>
<li class="toctree-l3"><a class="reference internal" href="#streamlines-lengths">Streamlines lengths</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#code-example-in-python">Code example in python</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../04.faq/index.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">References &amp; Acknowledgements</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../06.citingmicapipe/index.html">Citing micapipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06.references/index.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06.acknowledge/index.html">Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #261F4A" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">micapipe</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">downsample tractograms</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/pages/04.tckdownsample/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="how-to-downsample-a-tractogram">
<span id="tckdownsample"></span><h1>How to downsample a tractogram<a class="headerlink" href="#how-to-downsample-a-tractogram" title="Permalink to this headline">¶</a></h1>
<p>By default, our pipeline does not save the tractograms or compress them after connectome calculations (<code class="docutils literal notranslate"><span class="pre">-SC</span></code>). The main reason is storage and computational time, which is a significant issue even when compression is used (for 10 million streamlines, uncompressed/compressed tractograms are ~14G/3G per case). When running the pipeline, it is possible to keep tractograms (optional argument <code class="docutils literal notranslate"><span class="pre">-keep_tck</span></code>), but it’s up to the final user to compress them.
Below you can check the estimated sizes and computation times of different tractograms.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 24%" />
<col style="width: 23%" />
<col style="width: 33%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>Streamlines</strong></p></td>
<td><p><strong>Original size MB</strong></p></td>
<td><p><strong>Reduced size MB</strong></p></td>
<td><p><strong>Computing time (seconds)</strong></p></td>
</tr>
<tr class="row-even"><td><p>10,000</p></td>
<td><p>19</p></td>
<td><p>4</p></td>
<td><p>2.86</p></td>
</tr>
<tr class="row-odd"><td><p>100,000</p></td>
<td><p>152</p></td>
<td><p>32</p></td>
<td><p>21.05</p></td>
</tr>
<tr class="row-even"><td><p>1,000,000</p></td>
<td><p>1,428</p></td>
<td><p>303</p></td>
<td><p>479.52</p></td>
</tr>
<tr class="row-odd"><td><p>10,000,000</p></td>
<td><p>1,4262</p></td>
<td><p>3,019</p></td>
<td><p>28920.14</p></td>
</tr>
</tbody>
</table>
<p>Our example is based on the tutorial provided by DIPY called <a class="reference external" href="https://dipy.org/documentation/1.1.1./examples_built/streamline_length/">Streamline length and size reduction</a>, but applied to <code class="docutils literal notranslate"><span class="pre">micapipe</span></code>’s outputs.
After a tractogram was saved (using the flags <code class="docutils literal notranslate"><span class="pre">-SC</span> <span class="pre">-keep_tck</span></code>), it could be downsampled using <code class="docutils literal notranslate"><span class="pre">DIPY</span> <span class="pre">1.5.0</span></code> and <code class="docutils literal notranslate"><span class="pre">nibabel</span> <span class="pre">3.2.1</span></code> tools.</p>
<p>We use the function <code class="docutils literal notranslate"><span class="pre">approx_polygon_track</span></code> which reduces the number of points on each streamline without changing the length or shape, thus is an ideal methods for lossy compression of streamlines.
The following figures show how this procedure reduces the number of points without changing the length, therefore reducing the file size (we used a 10,000 streamlines tractogram for the figures).</p>
<div class="section" id="changes-before-and-after-downsampling-a-tractogram">
<h2>Changes before and after downsampling a tractogram<a class="headerlink" href="#changes-before-and-after-downsampling-a-tractogram" title="Permalink to this headline">¶</a></h2>
<div class="section" id="number-of-points">
<h3>Number of points<a class="headerlink" href="#number-of-points" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center">
<img alt="alternate text" src="../../_images/tck_points.png" />
</div>
<br></div>
<div class="section" id="streamlines-lengths">
<h3>Streamlines lengths<a class="headerlink" href="#streamlines-lengths" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center">
<img alt="alternate text" src="../../_images/tck_lengths-lines.png" />
</div>
<br></div>
</div>
<div class="section" id="code-example-in-python">
<h2>Code example in python<a class="headerlink" href="#code-example-in-python" title="Permalink to this headline">¶</a></h2>
<p>Bellow you can find an example of downsampling a tractogram. The code is mean to run from the <code class="docutils literal notranslate"><span class="pre">derivatives/micapipe</span></code> directory:</p>
<div class="sphinx-tabs docutils container">
<div class="ui top attached tabular menu sphinx-menu docutils container">
<div class="active item sphinx-data-tab-UHl0aG9u docutils container">
<div class="docutils container">
<p>Python</p>
</div>
</div>
</div>
<div class="ui bottom attached sphinx-tab tab segment code-tab sphinx-data-tab-UHl0aG9u active docutils container">
<div class="highlight-py notranslate"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><span class="c1"># Set enviroment</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">from</span> <span class="nn">dipy.io.streamline</span> <span class="kn">import</span> <span class="n">load_tractogram</span><span class="p">,</span> <span class="n">save_tractogram</span>
<span class="kn">from</span> <span class="nn">dipy.tracking.distances</span> <span class="kn">import</span> <span class="n">approx_polygon_track</span>

<span class="c1"># Function to downsample a tractogram</span>
<span class="k">def</span> <span class="nf">compress_tck</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>

    <span class="c1"># Load reference anatomy</span>
    <span class="n">reference_anatomy</span><span class="o">=</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">subject</span> <span class="o">+</span> <span class="s1">&#39;/dwi/&#39;</span> <span class="o">+</span> <span class="n">subject</span> <span class="o">+</span> <span class="s1">&#39;_ses-01_space-dwi_desc-b0.nii.gz&#39;</span><span class="p">)</span>

    <span class="c1"># load tractogram</span>
    <span class="n">bundle</span> <span class="o">=</span> <span class="n">load_tractogram</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">reference_anatomy</span><span class="p">,</span> <span class="n">bbox_valid_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This bundle has </span><span class="si">%d</span><span class="s1"> streamlines&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">bundle</span><span class="p">))</span>

    <span class="c1">#tractogram size reduction</span>
    <span class="n">bundle_downsampled</span> <span class="o">=</span> <span class="p">[</span><span class="n">approx_polygon_track</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">streamlines</span><span class="p">]</span>

    <span class="c1"># Replace the tractogram with the downsample</span>
    <span class="n">bundle</span><span class="o">.</span><span class="n">streamlines</span> <span class="o">=</span> <span class="n">bundle_downsampled</span>

    <span class="c1"># Save new TCK file</span>
    <span class="n">save_tractogram</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tck&#39;</span><span class="p">,</span><span class="s1">&#39;_downsampled.tck&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downsampled tractogram was saved&#39;</span><span class="p">)</span>

<span class="c1"># Compress a tractogram</span>
<span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;sub-01&#39;</span>
<span class="n">tck</span> <span class="o">=</span> <span class="n">subject</span> <span class="o">+</span> <span class="s1">&#39;/dwi/&#39;</span> <span class="o">+</span> <span class="n">subject</span> <span class="o">+</span> <span class="s1">&#39;_space-dwi_desc-iFOD1-10M_tractography.tck&#39;</span>
<span class="n">compress_tck</span><span class="p">(</span><span class="n">tck</span><span class="p">)</span>
</pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../04.faq/index.html" class="btn btn-neutral float-right" title="FAQ" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../04.gradients/index.html" class="btn btn-neutral float-left" title="Building gradients" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2022, micapipe

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a 
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a> and modified by SL and RRC 

</footer>

        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
         .wy-nav-content { max-width: none; }
  </style>


  <footer>
    
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a 
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. Modified by SL 🤠 

  </footer>



</body>
</html>