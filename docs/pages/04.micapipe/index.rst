.. _micapipeproc:

.. title:: micapipe

Pre-processing with ``micapipe``
======================================================================

Neocortical and subcortial feature post-processing with ``z-brains`` relies heavily on `micapipe <https://https://micapipe.readthedocs.io/>`_, 
an openly available, multimodal MRI pre-processing pipeline. The sections below outline the minimal pre-processing that should be perfomed with 
``micapipe`` prior to running ``z-brains``, for each modality available in your dataset. 

.. admonition:: The Brain Imaging Data Structure (BIDS) 

	The `Brain Imaging Data Structure (BIDS) <https://bids.neuroimaging.io>`_ is a widely used directory and file naming convention in brain imaging. To run ``micapipe``, and subsequently ``z-brains``, your raw data needs to be conform to BIDS standards. 

Core to the ``z-brains`` architecture are the computation and resampling of neocortical surface segmentations via ``micapipe``. This allows for smoothing and normalization of available features across participants. 


Neocortical thickness and subcortical volume 
--------------------------------------------------------

Generation of these features rely on the `structural processing of micapipe <https://micapipe.readthedocs.io/en/latest/pages/02.structuralproc/index.html>`_

Key outputs of these modules for ``z-brains`` are:

.. list-table::
  :widths: 10 1000
  :header-rows: 1

  * - **Outputs**
    - **Description**
  * - Processed T1w image
    - A new space, ``nativepro``, is created and used for all downstream processing and cross-modality registrations. This image is generated from the intensity non-uniformity-corrected, rescaled raw T1w image. If multiple T1w acquisitions are available, their are co-registered and average prior to intensity correction steps. 
  * - Neocortical surface reconstructions
    - Neocortical surfaces are initially generated by FreeSurfer/FastSurfer (called through ``micapipe``), and resampled to symmetric, standard templates (fs-LR) aligned to the participant's nativepro space.
  * - Neocortical thickness
    - Thickness estimates are computed by FreeSurfer/FastSurfer, and mapped to resampled fs-LR surface templates
  * - Subcortical structure volume
    - Subcortical volumes are provided by FreeSurfer/FastSurfer (called through ``micapipe``)
  * - Subcortical structure segmentation
    - Subcortical structures are segmented using FSL FIRST, and the resulting parcellation is used to sample image intensities for relevant features. 


FLAIR intensity
--------------------------------------------------------

Generation of these features rely on the `FLAIR processing of micapipe <https://micapipe.readthedocs.io/en/latest/pages/02.flairproc/index.html>`_

Key outputs of this module for ``z-brains`` are:

.. list-table::
  :widths: 10 1000
  :header-rows: 1

  * - **Outputs**
    - **Description**
  * - Processed FLAIR image
    - Pre-processed FLAIR image (bias correction, intensity clamping and rescaling, and normalization to gray/white matter interface values) co-registered to ``nativepro`` space. This image is used for intensity sampling in ``z-brains`` subcortical and hippocampal processing modules.
  * - Processed FLAIR intensities mapped to neocortical surface 
    - Neocortical surfaces are initially generated by FreeSurfer/FastSurfer (called through ``micapipe``), and resampled to symmetric, standard templates (fs-LR) aligned to the participant's nativepro space.


Quantitative T1 intensity
--------------------------------------------------------

Generation of these features rely on the `Microstructural profile covariance module of micapipe <https://micapipe.readthedocs.io/en/latest/pages/02.microstructproc/index.html>`_

Key outputs of this module for ``z-brains`` are:

.. list-table::
  :widths: 10 1000
  :header-rows: 1

  * - **Outputs**
    - **Description**
  * - Processed T1 map volume
    - The qT1 image co-registered to ``nativepro`` space. This image is used for intensity sampling in ``z-brains`` subcortical and hippocampal processing modules.
  * - T1 relaxation times mapped to neocortical surfaces
    - Neocortical surfaces are initially generated by FreeSurfer/FastSurfer (called through ``micapipe``), and resampled to symmetric, standard templates (fs-LR) aligned to the participant's nativepro space.


Mean diffusivity (MD) and fractional anisotropy (FA)
--------------------------------------------------------

Generation of these features rely on the `diffusion-weighted imaging module of micapipe <hhttps://micapipe.readthedocs.io/en/latest/pages/02.dwiproc/index.html>`_

Key outputs of this module for ``z-brains`` are:

.. list-table::
  :widths: 10 1000
  :header-rows: 1

  * - **Outputs**
    - **Description**
  * - Processed MD volume
    - The MD image co-registered to ``nativepro`` space. This image is used for intensity sampling in ``z-brains`` subcortical and hippocampal processing modules.
  * - Processed FA volume
    - The FA image co-registered to ``nativepro`` space. This image is used for intensity sampling in ``z-brains`` subcortical and hippocampal processing modules.
  * - MD and FA values mapped to neocortical surfaces
    - Neocortical surfaces are initially generated by FreeSurfer/FastSurfer (called through ``micapipe``), and resampled to symmetric, standard templates (fs-LR) aligned to the participant's nativepro space.


